---
title: "Vota Unicamp!"
author: "Grupo"
output: html_document
---

#Introdução

```{r input, message=FALSE}
Sys.setlocale("LC_TIME")
library(stringr)
library(rvest)
library(googleVis)
library(leaflet)
page = read_html('http://votaunicamp.herokuapp.com/results/', encoding='UTF-8')
tbl = html_table(page)[[2]]
head(tbl)
```

## Formatação de Dados

```{r format, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}
mytbl = data.frame(codigo=as.integer(str_extract(tbl$Curso, "^\\d+")),
                   nivel=NA,
                   curso=gsub("^(\\d+) - (.*)$", "\\2", tbl$Curso),
                   total=tbl$Total,
                   sim=as.integer(str_extract(tbl$Sim, "^\\d+")),
                   nao=as.integer(str_extract(tbl$Não, "^\\d+")),
                   abstencao=as.integer(str_extract(tbl$Abstenções, "^\\d+")))
nivel = str_extract(mytbl$curso, "(Dou|Mes)[a-z]+")
nivel[grepl("Mes", nivel)] = "Mestrado"
nivel[grepl("Dou", nivel)] = "Doutorado"
nivel[is.na(nivel)] = "Graduacao"
mytbl$nivel = nivel
rm(nivel)
mytbl$curso = gsub("(Mes|Dou).+ em (.*)$", "\\2", mytbl$curso)
head(mytbl)
```

```{r institutos, message=FALSE, echo=FALSE, warning=FALSE}
n=length(mytbl$curso)
instituto=rep(0,n)
area=rep(0,n)

etiqueta = function(nivel,cod){
  
  if(nivel=="Graduacao"){
    cursosg = read.table("Grad.csv", header = TRUE, sep = ",")
    ind = which(cursosg$cod==cod)
    instituto = as.character(cursosg$grad[ind])
    area = as.character(cursosg$area[ind])
  }
  if(nivel=="Doutorado"){
    cursosd = read.table("Dout.csv", header = TRUE, sep = ",")
    ind = which(cursosd$cod==cod)
    instituto = as.character(cursosd$dou[ind])
    area = as.character(cursosg$area[ind])
  }
   if(nivel=="Mestrado"){
    cursosm = read.table("Mestr.csv", header = TRUE, sep = ",")
    ind = which(cursosm$cod==cod)
    instituto = as.character(cursosm$mes[ind])
    area = as.character(cursosg$area[ind])
   }
  
  return (instituto)
}

for(i in 1:n){
  instituto[i] = etiqueta(mytbl$nivel[i], mytbl$codigo[i] )
}


mytbl=cbind(instituto,mytbl)
```

## Gauge Plots

```{r plot_gauge}
tbl0 = subset(mytbl, nivel=='Graduacao')
tbl0$pnao = round(tbl0$nao/tbl0$total*100, 0)
gauge = gvisGauge(tbl0[, c('curso', 'pnao')], 'curso', 'nao',
                  options=list(min=0, max=100, greenFrom=0,
                                 greenTo=20, yellowFrom=40, yellowTo=60,
                                 redFrom=80, redTo=100, width=400, height=300))
plot(gauge)
```

## Obtenção de Dados Geográficos

Obter localizações (lat/lon) por meio do OpenStreet Maps:

- Abrir OpenStreet Maps (OSM) em (http://www.openstreetmap.org/#map=16/-22.8173/-47.0677)
- Dar zoom máximo no instituto de interesse
- Olhar o endereço na barra de endereço após o zoom
- Atualizar o data.frame abaixo com as informações

```{r enderecos}
ends = data.frame(instituto=c('IMECC', 'IFGW', 'IB', 'FEM', 'FEF', 'FEEC', 'FEC', 'FEA', 'FCM', 'IFCH','IEL', 'IA', 'IC', 'IE', 'IG', 'IQ', 'FE', 'FEAGRI', 'FEQ', 'PROFIS', 'FCF'),
           lat=c(-22.81583,-22.81657,-22.81935,-22.81938,-22.81476,-22.82132,-22.81596,-22.82063,-22.83063,-22.81546, -22.81537, -22.81531, -22.81488, -22.81480, -22.81328, -22.81889, -22.81658, -22.81927, -22.81989, -22.81749, -22.81770),
           lon=c(-47.06769,-47.06698,-47.06953,-47.06592,-47.07333,-47.06587,-47.06383,-47.06746,-47.06199,-47.06838,-47.06909, -47.07009, -47.06484, -47.06590, -47.06871, -47.06779, -47.06566, -47.06042,-47.06511, -47.06847, -47.07084 )) 
map = leaflet()
map = addTiles(map)
map = addCircleMarkers(map, lat=ends$lat, lng=ends$lon, popup = ends$instituto)

ends= cbind(ends, propn = propn_total[1:21])

pal= colorQuantile("RdBu",ends$propn, n=8)
map = leaflet()
map = addTiles(map)
map = addCircleMarkers(map, lat=ends$lat, lng=ends$lon, popup = ends$instituto, color = pal(ends$propn))
map
```

##Proporções

```{r stats, message=FALSE, echo=FALSE, warning=FALSE}
#Proporção de Não
p = with(mytbl, nao/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
colnames(ics) = c("lower", "upper")
mytbl$p = p
mytbl = cbind(mytbl, ics)
```


```{r message=FALSE, echo=FALSE, warning=FALSE}
#Proporção de Sim
p = with(mytbl, sim/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
mytbl[,11]=p
mytbl[,12]=ics[,1]
mytbl[,13]=ics[,2]
```


```{r message=FALSE, echo=FALSE, warning=FALSE}
#Proporção de Abstenho
p = with(mytbl, abstencao/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
mytbl[,14]=p
mytbl[,15]=ics[,1]
mytbl[,16]=ics[,2]
names(mytbl) <- c(names(mytbl)[1:7],"p-nao", "inf-n", "sup-n", "p-sim", "inf-s","sup-s","p-abs", "inf-a", "sup-a")
mytbl[,8:16]=round(mytbl[,8:16],2)

```

###Proporções por instituto

```{r}
nao_total=rep(0,24)
for(i in 1:24){
 nao_total[i]=c(sum(mytbl$nao[which(instituto==ends$instituto[i])])) 
}

sim_total=rep(0,24)
for(i in 1:24){
 sim_total[i]=c(sum(mytbl$sim[which(instituto==ends$instituto[i])])) 
}

abs_total = rep(0,24)
for(i in 1:24){
 abs_total[i]=c(sum(mytbl$abstencao[which(instituto==ends$instituto[i])])) 
}

props_total=rep(0,24)
for(i in 1:24){
  props_total[i] = sim_total[i]/(nao_total[i]+sim_total[i]+abs_total[i])
  props_total[i] = round(props_total[i],2)
}


propn_total=rep(0,24)
for(i in 1:24){
  propn_total[i] = nao_total[i]/(nao_total[i]+sim_total[i]+abs_total[i])
  propn_total[i] = round(propn_total[i],2)
}

propabs_total=rep(0,24)
for(i in 1:24){
  propabs_total[i] = abs_total[i]/(nao_total[i]+sim_total[i]+abs_total[i])
  propabs_total[i] = round(propabs_total[i],2)
}

total_inst=rep(0,24)
for(i in 1:24){
 total_inst[i]=c(sum(mytbl$total[which(instituto==ends$instituto[i])]))
}

dados=cbind(ends$instituto,nao_total, sim_total, abs_total, propn_total, props_total, propabs_total, total_inst)
```

Gráfico de barras do total de votos por instituto e tabela com os votos

```{r echo=FALSE, warning=FALSE}
library(formattable)
dados2 = as.data.frame(dados[,-c(5:7)])
names(dados2) = c("Instituto", "Não", "Sim", "Abstenções", "Total")
barplot(as.numeric(dados[,8]), main = "Total de votos por Instituto", col = c("aliceblue","antiquewhite1", "antiquewhite2","antiquewhite3", "antiquewhite4","darkslategray2","darkslategray3","darkslategray4","darkslategray","azure1", "azure2","azure3", "azure4", "bisque1", "bisque2", "bisque3", "bisque4", "darkolivegreen1","darkolivegreen2","darkolivegreen3","darkolivegreen4","darkseagreen2","darkseagreen3","darkseagreen4"))
legend("topright",legend=c('IMECC', 'IFGW', 'IB', 'FEM', 'FEF', 'FEEC', 'FEC', 'FEA', 'FCM', 'IFCH','IEL', 'IA', 'IC', 'IE', 'IG', 'IQ', 'FE', 'FEAGRI', 'FEQ', 'PROFIS', 'FCF'),fill = c("aliceblue","antiquewhite1", "antiquewhite2","antiquewhite3", "antiquewhite4","darkslategray2","darkslategray3","darkslategray4","darkslategray","azure1", "azure2","azure3", "azure4", "bisque1", "bisque2", "bisque3", "bisque4", "darkolivegreen1","darkolivegreen2","darkolivegreen3","darkolivegreen4","darkseagreen2","darkseagreen3","darkseagreen4"), ncol=3 ,bty = "n", cex = 0.55)
formattable(dados2)
```

## Intervalos de Confiança

```{r stats}
p = with(mytbl, nao/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
colnames(ics) = c("lower", "upper")
mytbl$p = p
mytbl = cbind(mytbl, ics)
```

Intervalo de confiança para a proporção:

