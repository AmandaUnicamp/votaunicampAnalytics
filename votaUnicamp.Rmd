---
title: "Vota Unicamp!"
author: "Yasmine"
output: html_document
---

## Setup

```{r input, message=FALSE}
Sys.setlocale("LC_TIME", "Portuguese")
library(stringr)
library(rvest)
library(googleVis)
library(leaflet)
page = read_html('http://votaunicamp.herokuapp.com/results/', encoding="UTF-8")
tbl = html_table(page)[[2]]
head(tbl)
```

## Formatação de Dados

```{r format}
names(tbl)=c("Curso", "Total", "Sim", "Abstenções", "Não")
mytbl = data.frame(codigo=as.integer(str_extract(tbl$Curso, "^\\d+")),
                   nivel=NA,
                   curso=gsub("^(\\d+) - (.*)$", "\\2", tbl$Curso),
                   total=tbl$Total,
                   sim=as.integer(str_extract(tbl$Sim, "^\\d+")),
                   nao=as.integer(str_extract(tbl$Não, "^\\d+")),
                   abstencao=as.integer(str_extract(tbl$Abstenções, "^\\d+")))
nivel = str_extract(mytbl$curso, "(Dou|Mes)[a-z]+")
nivel[grepl("Mes", nivel)] = "Mestrado"
nivel[grepl("Dou", nivel)] = "Doutorado"
nivel[is.na(nivel)] = "Graduacao"
mytbl$nivel = nivel
rm(nivel)
mytbl$curso = gsub("(Mes|Dou).+ em (.*)$", "\\2", mytbl$curso)
head(mytbl)

mytbl$curso[1] = ("Matemática")
mytbl$curso[2] = ("Matemática")
mytbl$curso[3] = ("Engenharia Mecânica")
mytbl$curso[4] = ("Engenharia Mecânica")
mytbl$curso[5] = ("Ciências do Esporte")
mytbl$curso[6] = ("Engenharia de Manufatura")
mytbl$curso[7] = ("Engenharia da Produção")
mytbl$curso[8] = ("Gestão de Empresas")
mytbl$curso[9] = ("Nutrição")
mytbl$curso[10] = ("Engenharia Física")
mytbl$curso[11] = ("Administração")
mytbl$curso[12] = ("Genética e Biologia Molecular")
mytbl$curso[13] = ("Engenharia Elétrica")
mytbl$curso[14] = ("Engenharia Elétrica")
mytbl$curso[15] = ("Engenharia Civil")
mytbl$curso[16] = ("Engenharia de Alimentos")
mytbl$curso[17] = ("Odontologia")
mytbl$curso[18] = ("Medicina")
mytbl$curso[19] = ("Ciências Sociais")
mytbl$curso[20] = ("Ciências Econômicas")
mytbl$curso[21] = ("Linguística")
mytbl$curso[22] = ("História")
mytbl$curso[23] = ("Estatística")
mytbl$curso[24] = ("Estatística")
mytbl$curso[25] = ("PROFIS")
mytbl$curso[26] = ("Música")
mytbl$curso[27] = ("Artes Cênicas")
mytbl$curso[28] = ("Educação Física")
mytbl$curso[29] = ("Matemática Aplicada e Computacional")
mytbl$curso[30] = ("Licenciatura em Matemática")
mytbl$curso[31] = ("Ciências da Computação")
mytbl$curso[32] = ("Ciências da Nutrição e do Esporte e do Metabolismo")
mytbl$curso[33] = ("Engenharia da Computação")
mytbl$curso[34] = ("Superior Tecn. Análise e Desenv.Sistemas")
mytbl$curso[35] = ("pedagogia")
mytbl$curso[36] = ("Engenharia Química")
mytbl$curso[37] = ("Física")
mytbl$curso[38] = ("Licenciatura em Física")
mytbl$curso[39] = ("Linguística Aplicada")
mytbl$curso[40] = ("Engenharia Elétrica")
mytbl$curso[41] = ("Ciência da Computação")
mytbl$curso[42] = ("Engenharia de Alimentos")
mytbl$curso[43] = ("Ciências Sociais")
mytbl$curso[44] = ("Educação Física")
mytbl$curso[45] = ("Licenciatura em Ciências Biológicas")
mytbl$curso[46] = ("Ciências Econômicas")
mytbl$curso[47] = ("Arquitetura e Urbanismo")
mytbl$curso[48] = ("Engenharia de Controle e Automação")
mytbl$curso[49] = ("Química")
mytbl$curso[50] = ("Química")
mytbl$curso[51] = ("Química Tecnológica")
mytbl$curso[52] = ("Matemática")
mytbl$curso[53] = ("Matemática/Física/Mat.Apl. e Comp.")
mytbl$curso[54] = ("Ciência da Computação")
mytbl$curso[55] = ("Geologia")
mytbl$curso[56] = ("Física")
mytbl$curso[57] = ("Química")
mytbl$curso[58] = ("Geografia")
mytbl$curso[59] = ("Licenciatura Integrada Química/Física")
mytbl$curso[60] = ("Teoria e História Literária")
mytbl$curso[61] = ("Fonoaudiologia")
mytbl$curso[62] = ("Ciências Biológicas")
mytbl$curso[63] = ("Superior Tecn. Análise e Desenv. Sistemas")
mytbl$curso[64] = ("Engenharia Elétrica")
mytbl$curso[65] = ("Genética e Biologia Molecular")
mytbl$curso[66] = ("Farmácia")
mytbl$curso[67] = ("Comunicação Social - Midialogia")
mytbl$curso[68] = ("Ciências Sociais")
mytbl$curso[69] = ("Licenciatura em Letras - Português")
mytbl$curso[70] = ("Educação")
mytbl$curso[71] = ("Estudos Literários")
mytbl$curso[72] = ("Educação Física")
mytbl$curso[73] = ("Matemática Aplicada")
mytbl$curso[74] = ("Engenharia Agrícola")
mytbl$curso[75] = ("Mestr.Bioc. e Tec. de Produtos Bioativos")
mytbl$curso[76] = ("Engenharia Ambiental")
mytbl$curso[77] = ("Engenharia Química")
mytbl$curso[78] = ("Dout.na Área Int. Plan.Sist.Energéticos")
mytbl$curso[79] = ("Ciências e Engenharia do Petróleo")

```

## Gauge Plots

```{r plot_gauge}
tbl0 = subset(mytbl, nivel=='Graduacao')
tbl0$pnao = round(tbl0$nao/tbl0$total*100, 0)
gauge = gvisGauge(tbl0[, c('curso', 'pnao')], 'curso', 'nao',
                  options=list(min=0, max=100, greenFrom=0,
                                 greenTo=20, yellowFrom=40, yellowTo=60,
                                 redFrom=80, redTo=100, width=400, height=300))
plot(gauge)
```

## Obtenção de Dados Geográficos

Obter localizações (lat/lon) por meio do OpenStreet Maps:

- Abrir OpenStreet Maps (OSM) em (http://www.openstreetmap.org/#map=16/-22.8173/-47.0677)
- Dar zoom máximo no instituto de interesse
- Olhar o endereço na barra de endereço após o zoom
- Atualizar o data.frame abaixo com as informações

```{r enderecos}
ends = data.frame(instituto=c('IMECC', 'IFGW', 'IB', 'FEM', 'FEF', 'FEEC', 'FEC', 'FEA', 'FCM', 'IFCH','IEL', 'IA', 'IC', 'IE', 'IG', 'IQ', 'FE', 'FEAGRI'),
           lat=c(-22.81583,-22.81657,-22.81935,-22.81938,-22.81476,-22.82132,-22.81596,-22.82063,-22.83063,-22.81546, -22.81537, -22.81531, -22.81488, -22.81480, -22.81328, -22.81889, -22.81658, -22.81927),
           lon=c(-47.06769,-47.06698,-47.06953,-47.06592,-47.07333,-47.06587,-47.06383,-47.06746,-47.06199,-47.06838,-47.06909, -47.07009, -47.06484, -47.06590, -47.06871, -47.06779, -47.06566, -47.06042))
map = leaflet()
map = addTiles(map)
map = addCircleMarkers(map, lat=ends$lat, lng=ends$lon, popup = ends$instituto)
map
```

## Intervalos de Confiança

Proporção de Não
```{r stats}
p = with(mytbl, nao/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
colnames(ics) = c("lower", "upper")
mytbl$p = p
mytbl = cbind(mytbl, ics)
```

Proporção de Sim
```{r}
p = with(mytbl, sim/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
mytbl[,11]=p
mytbl[,12]=ics[,1]
mytbl[,13]=ics[,2]
```

Proporção de Abstenho
```{r}
p = with(mytbl, abstencao/(total))
mes = qnorm(.975)*sqrt(1/(4*mytbl$total))
ics = cbind(pmax(p-mes, 0), pmin(p+mes, 1))
mytbl[,14]=p
mytbl[,15]=ics[,1]
mytbl[,16]=ics[,2]
names(mytbl) <- c(names(mytbl)[1:7],"p-nao", "inf-n", "sup-n", "p-sim", "inf-s","sup-s","p-abs", "inf-a", "sup-a")
mytbl[,8:16]=round(mytbl[,8:16],2)
```